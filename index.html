<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NWRTW Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f7fafc; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#059669;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    header { padding:18px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
    .brand { font-weight:700; letter-spacing:.2px; }
    #version-line { padding:8px 20px; color:var(--muted); font-size:12px; border-bottom:1px solid var(--border); }
    .tabs { display:flex; gap:10px; padding:12px 20px; border-bottom:1px solid var(--border); background:#fbfdff; }
    .tab { padding:10px 14px; border-radius:10px; cursor:pointer; background:#fff; border:1px solid var(--border); color:var(--muted); box-shadow:0 1px 1px rgba(0,0,0,.03); }
    .tab.active { color:var(--text); border-color:#cfd8e3; }
    .tab:disabled { opacity:.6; cursor:not-allowed; }
    main { padding:18px 20px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .title { font-size:16px; font-weight:700; margin:0 0 12px; }

    /* Filters layout (top-aligned, equal vertical structure) */
    .filters {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:12px; margin:10px 0 8px; align-items:start;
    }
    .filter-field { display:flex; flex-direction:column; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select { width:100%; padding:10px 12px; color:var(--text); background:#fff; border:1px solid var(--border); border-radius:10px; }
    .hint { font-size:11px; color:var(--muted); margin-top:4px; min-height:16px; }
    .hint.hidden { visibility:hidden; }

    .actions { display:flex; gap:10px; align-self:start; margin-top:22px; }
    .btn { appearance:none; border:1px solid transparent; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; transition: transform .02s, box-shadow .15s; }
    .btn-primary { background:var(--accent); color:#fff; box-shadow:0 2px 6px rgba(37,99,235,.2); }
    .btn-primary:hover { filter:brightness(1.03); }
    .btn-primary:active { transform:translateY(1px); }
    .btn-ghost { background:#fff; color:var(--text); border:1px solid var(--border); }

    .bar { height:3px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); border-radius:999px; width:0; transition:width .35s; margin:6px 0 2px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); }
    th { color:var(--muted); font-weight:600; background:#fafbff; }
    tr:nth-child(even) td { background:#fcfdff; }
    tfoot td { background:#f3f6ff; font-weight:700; border-top:2px solid #c7d2fe; }
    .footer { margin-top:10px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff; }
    .error { color:#b91c1c; font-weight:600; }
    .muted { color:var(--muted); }
    .right { text-align:right; }

    /* ---- Donut chart styles ---- */
    .chart-wrap { margin-top:14px; display:none; }
    .chart-title { font-weight:700; margin:6px 0 8px; color:#111827; }
    .chart-flex { display:flex; gap:24px; align-items:center; flex-wrap:wrap; }
    .donut-box { position:relative; width:200px; height:200px; }
    .donut { width:100%; height:100%; border-radius:50%; background:#eef2ff; }
    .donut-hole {
      position:absolute; inset:22%; background:var(--card); border-radius:50%;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      box-shadow: inset 0 0 0 1px var(--border);
      text-align:center;
    }
    .donut-hole .big { font-size:20px; font-weight:800; }
    .donut-hole .small { font-size:11px; color:var(--muted); margin-top:2px; }

    .legend { list-style:none; margin:0; padding:0; columns:1; column-gap:18px; }
    @media (min-width: 720px) { .legend { columns:2; } }
    @media (min-width: 980px) { .legend { columns:3; } }
    .legend li { break-inside:avoid; display:flex; align-items:center; gap:8px; margin:6px 0; }
    .swatch { width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.08); }
    .legend .pct { color:var(--muted); margin-left:auto; padding-left:12px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">NWRTW • Dashboard</div>
  </header>

  <div id="version-line"></div>

  <nav class="tabs">
    <button class="tab active" data-tab="program-status">Patients By Program/Status</button>
    <button class="tab" data-tab="tbd-2" disabled>— next report —</button>
    <button class="tab" data-tab="tbd-3" disabled>— next report —</button>
  </nav>

  <main>
    <!-- Tab 1: Patients By Program/Status -->
    <section class="card" id="tab-program-status">
      <h2 class="title">Patients By Program/Status</h2>

      <div class="filters">
        <div class="filter-field">
          <label for="program">Program</label>
          <select id="program"></select>
          <div class="hint hidden" id="programHint">Scroll to see more programs</div>
        </div>

        <div class="filter-field">
          <label for="recordType">Record Type</label>
          <select id="recordType">
            <option value="ALL">ALL</option>
            <option value="Active">Active</option>
            <option value="Non Active">Non Active</option>
          </select>
          <div class="hint hidden">&nbsp;</div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="runBtn">Load Results</button>
          <button class="btn btn-ghost" id="clearBtn" title="Reset filters">Reset</button>
        </div>
      </div>

      <div id="progress" class="bar"></div>

      <table>
        <thead>
          <tr><th>Program</th><th>Status</th><th>Count</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="muted">No results</td></tr>
        </tbody>
        <tfoot id="tfoot" style="display:none;">
          <tr>
            <td class="right" colspan="2">Total</td>
            <td id="totalCell">0</td>
          </tr>
        </tfoot>
      </table>

      <!-- Donut chart -->
      <div id="chartSection" class="chart-wrap">
        <div class="chart-title">Status breakdown</div>
        <div class="chart-flex">
          <div class="donut-box">
            <div class="donut" id="donut"></div>
            <div class="donut-hole">
              <div class="big" id="donutTotal">0</div>
              <div class="small">Total</div>
            </div>
          </div>
          <ul class="legend" id="legend"></ul>
        </div>
      </div>

      <div class="footer">
        <div id="meta"></div>
        <div><span class="pill" id="source"></span></div>
      </div>
    </section>

    <!-- Future tabs -->
    <section class="card" id="tab-tbd-2" style="display:none"><h2 class="title">Coming soon</h2></section>
    <section class="card" id="tab-tbd-3" style="display:none"><h2 class="title">Coming soon</h2></section>
  </main>

  <script>
    // ===== Config =====
    const curr_version = '1.7';
    const API_BASE = 'https://nwrtw-program-status-totals.dennis-e64.workers.dev';

    // Version line
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('version-line');
      if (el) el.textContent = `Version: ${curr_version}`;
    });

    // Tabs (ready for future screens)
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.disabled) return;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).style.display = '';
      });
    });

    // Elements
    const programEl = document.getElementById('program');
    const programHint = document.getElementById('programHint');
    const recordTypeEl = document.getElementById('recordType');
    const tbody = document.getElementById('tbody');
    const tfoot = document.getElementById('tfoot');
    const totalCell = document.getElementById('totalCell');
    const chartSection = document.getElementById('chartSection');
    const donut = document.getElementById('donut');
    const donutTotal = document.getElementById('donutTotal');
    const legend = document.getElementById('legend');
    const meta = document.getElementById('meta');
    const source = document.getElementById('source');
    const progress = document.getElementById('progress');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');

    function setLoading(on){
      progress.style.width = on ? '90%' : '0%';
      runBtn.disabled = !!on;
      runBtn.textContent = on ? 'Loading…' : 'Load Results';
    }

    async function fetchPrograms(){
      try {
        const r = await fetch(`${API_BASE}/programs`, { method: 'GET' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        const items = (j.programs || ['ALL']).filter(Boolean);
        programEl.innerHTML = items.map(v => `<option value="${v}">${v}</option>`).join('');
        programEl.value = 'ALL';
        programHint.classList.toggle('hidden', items.length <= 12);
      } catch (e) {
        programEl.innerHTML = `<option value="ALL">ALL</option>`;
        programEl.value = 'ALL';
        programHint.classList.add('hidden');
        meta.innerHTML = `<span class="error">Failed to load programs (${e.message})</span>`;
      }
    }

    // -------- Donut helpers --------
    const PALETTE = [
      "#2563eb","#059669","#f59e0b","#ef4444","#8b5cf6","#10b981",
      "#f97316","#06b6d4","#84cc16","#ec4899","#14b8a6","#a855f7"
    ];
    const hashToIndex = (s, m) => {
      let h = 0; for (let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0; return h % m;
    };

    function buildDonut(rows){
      const map = new Map();
      for (const r of rows) {
        const s = (r.status ?? "(blank)").toString();
        const c = Number(r.count || 0);
        map.set(s, (map.get(s) || 0) + c);
      }
      const total = Array.from(map.values()).reduce((a,b)=>a+b,0);
      const segments = Array.from(map.entries())
        .map(([status,count]) => ({
          status,
          count,
          color: PALETTE[hashToIndex(status, PALETTE.length)]
        }))
        .sort((a,b)=> b.count - a.count);
      return { total, segments };
    }

    function renderDonut({ total, segments }){
      if (!total || !segments.length) {
        chartSection.style.display = 'none';
        donut.style.background = "#eef2ff";
        donutTotal.textContent = "0";
        legend.innerHTML = "";
        return;
      }
      // conic-gradient
      let acc = 0;
      const parts = segments.map(seg => {
        const start = acc;
        acc += (seg.count / total) * 360;
        return `${seg.color} ${start}deg ${acc}deg`;
      });
      donut.style.background = `conic-gradient(${parts.join(',')})`;
      donutTotal.textContent = total.toString();

      // legend
      legend.innerHTML = segments.map(seg => {
        const pct = Math.round((seg.count/total)*100);
        return `<li><span class="swatch" style="background:${seg.color}"></span>
                  <span>${seg.status}</span>
                  <span class="pct">${seg.count} (${pct}%)</span></li>`;
      }).join('');

      chartSection.style.display = '';
    }

    async function fetchRows(){
      setLoading(true);
      try {
        const q = new URLSearchParams({
          program: programEl.value || 'ALL',
          recordType: recordTypeEl.value || 'ALL',
        });
        const r = await fetch(`${API_BASE}/totals?` + q.toString(), { method: 'GET' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        const rows = j.rows || [];

        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="muted">No results</td></tr>`;
          tfoot.style.display = 'none';
          totalCell.textContent = '0';
          renderDonut({ total:0, segments:[] });
        } else {
          tbody.innerHTML = rows.map(x => `
            <tr class="row">
              <td>${x.program}</td>
              <td>${x.status}</td>
              <td>${x.count}</td>
            </tr>`).join('');
          const total = rows.reduce((a,b)=>a + (Number(b.count)||0), 0);
          totalCell.textContent = total;
          tfoot.style.display = '';

          // render donut from current rows
          renderDonut(buildDonut(rows));
        }

        const totalShown = Number(totalCell.textContent || '0');
        meta.textContent = rows.length ? `${totalShown} total across ${rows.length} groups` : '';
        source.textContent = j.source === 'db-aggregated' ? 'DB aggregated' : 'Worker grouped';
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="error">Failed to load totals (${e.message})</td></tr>`;
        tfoot.style.display = 'none';
        totalCell.textContent = '0';
        renderDonut({ total:0, segments:[] });
        meta.textContent = '';
        source.textContent = '';
      } finally {
        setLoading(false);
      }
    }

    runBtn.addEventListener('click', fetchRows);
    clearBtn.addEventListener('click', () => {
      programEl.value = 'ALL';
      recordTypeEl.value = 'ALL';
      tbody.innerHTML = `<tr><td colspan="3" class="muted">No results</td></tr>`;
      tfoot.style.display = 'none';
      totalCell.textContent = '0';
      renderDonut({ total:0, segments:[] });
      meta.textContent = '';
      source.textContent = '';
    });

    (async function init(){
      await fetchPrograms();
      // user clicks "Load Results"
    })();
  </script>
</body>
</html>

