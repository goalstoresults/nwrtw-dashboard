<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NWRTW Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f7fafc;          /* page background */
      --card:#ffffff;        /* cards */
      --text:#1f2937;        /* primary text */
      --muted:#6b7280;       /* secondary text */
      --border:#e5e7eb;      /* borders */
      --accent:#2563eb;      /* primary accent (blue) */
      --accent-2:#059669;    /* secondary accent (green) */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
    }
    header {
      padding: 18px 20px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .brand { font-weight: 700; letter-spacing: .2px; }
    #version-line {
      padding: 8px 20px; color: var(--muted); font-size: 12px;
      border-bottom: 1px solid var(--border);
    }
    .tabs {
      display:flex; gap:10px; padding: 12px 20px; border-bottom: 1px solid var(--border);
      background:#fbfdff;
    }
    .tab {
      padding:10px 14px; border-radius:10px; cursor:pointer;
      background:#fff; border:1px solid var(--border); color:var(--muted);
      box-shadow: 0 1px 1px rgba(0,0,0,.03);
    }
    .tab.active { color: var(--text); border-color:#cfd8e3; }
    .tab:disabled { opacity:.6; cursor:not-allowed; }
    main { padding: 18px 20px; }
    .card {
      background: var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .title { font-size: 16px; font-weight: 700; margin:0 0 12px; }
    .filters {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:12px; margin: 10px 0 8px;
      align-items: end;
    }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select {
      width:100%; padding:10px 12px; color: var(--text); background:#fff;
      border:1px solid var(--border); border-radius:10px;
    }
    .actions { display:flex; gap:10px; }
    .btn {
      appearance:none; border:1px solid transparent; border-radius:10px;
      padding:10px 14px; font-weight:600; cursor:pointer;
      transition: transform .02s ease-in-out, box-shadow .15s;
    }
    .btn-primary {
      background: var(--accent); color: #fff; box-shadow: 0 2px 6px rgba(37,99,235,.2);
    }
    .btn-primary:hover { filter: brightness(1.03); }
    .btn-primary:active { transform: translateY(1px); }
    .btn-ghost { background:#fff; color: var(--text); border:1px solid var(--border); }
    .bar {
      height: 3px; background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 999px; width: 0; transition: width .35s; margin: 6px 0 2px;
    }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); }
    th { color: var(--muted); font-weight:600; background:#fafbff; }
    tr:nth-child(even) td { background: #fcfdff; }
    tfoot td {
      background:#f3f6ff; /* subtle blue-ish */
      font-weight:700;
      border-top: 2px solid #c7d2fe;
    }
    .footer {
      margin-top: 10px; font-size:12px; color: var(--muted);
      display:flex; justify-content: space-between; align-items:center; gap: 10px;
    }
    .pill {
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px;
      background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff;
    }
    .error { color:#b91c1c; font-weight:600; }
    .muted { color: var(--muted); }
    .right { text-align: right; }
  </style>
</head>
<body>
  <header>
    <div class="brand">NWRTW • Dashboard</div>
  </header>

  <div id="version-line"></div>

  <nav class="tabs">
    <button class="tab active" data-tab="program-status">Patients By Program/Status</button>
    <button class="tab" data-tab="tbd-2" disabled>— next report —</button>
    <button class="tab" data-tab="tbd-3" disabled>— next report —</button>
  </nav>

  <main>
    <!-- Tab 1: Patients By Program/Status -->
    <section class="card" id="tab-program-status">
      <h2 class="title">Patients By Program/Status</h2>

      <div class="filters">
        <div>
          <label for="program">Program</label>
          <select id="program"></select>
        </div>

        <div>
          <label for="recordType">Record Type</label>
          <select id="recordType">
            <option value="ALL">ALL</option>
            <option value="Active">Active</option>
            <option value="Non Active">Non Active</option>
          </select>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="runBtn">Load Results</button>
          <button class="btn btn-ghost" id="clearBtn" title="Reset filters">Reset</button>
        </div>
      </div>

      <div id="progress" class="bar"></div>

      <table>
        <thead>
          <tr><th>Program</th><th>Status</th><th>Count</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="muted">No results</td></tr>
        </tbody>
        <tfoot id="tfoot" style="display:none;">
          <tr>
            <td class="right" colspan="2">Total</td>
            <td id="totalCell">0</td>
          </tr>
        </tfoot>
      </table>

      <div class="footer">
        <div id="meta"></div>
        <div><span class="pill" id="source"></span></div>
      </div>
    </section>

    <!-- Future tabs -->
    <section class="card" id="tab-tbd-2" style="display:none"><h2 class="title">Coming soon</h2></section>
    <section class="card" id="tab-tbd-3" style="display:none"><h2 class="title">Coming soon</h2></section>
  </main>

  <script>
    // ===== Config =====
    const curr_version = '1.1'; // bump this when you release
    const API_BASE = 'https://nwrtw-program-status-totals.dennis-e64.workers.dev'; // CORS-based API

    // Version line
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('version-line');
      if (el) el.textContent = `Version: ${curr_version}`;
    });

    // Tabs (ready for future screens)
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.disabled) return;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).style.display = '';
      });
    });

    // Elements
    const programEl = document.getElementById('program');
    const recordTypeEl = document.getElementById('recordType');
    const tbody = document.getElementById('tbody');
    const tfoot = document.getElementById('tfoot');
    const totalCell = document.getElementById('totalCell');
    const meta = document.getElementById('meta');
    const source = document.getElementById('source');
    const progress = document.getElementById('progress');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');

    function setLoading(on){
      progress.style.width = on ? '90%' : '0%';
      runBtn.disabled = !!on;
      runBtn.textContent = on ? 'Loading…' : 'Load Results';
    }

    async function fetchPrograms(){
      try {
        const r = await fetch(`${API_BASE}/programs`, { method: 'GET' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        const items = j.programs || ['ALL'];
        programEl.innerHTML = items.map(v => `<option value="${v}">${v}</option>`).join('');
        programEl.value = 'ALL';
      } catch (e) {
        programEl.innerHTML = `<option value="ALL">ALL</option>`;
        meta.innerHTML = `<span class="error">Failed to load programs (${e.message})</span>`;
      }
    }

    async function fetchRows(){
      setLoading(true);
      try {
        const q = new URLSearchParams({
          program: programEl.value || 'ALL',
          recordType: recordTypeEl.value || 'ALL',
        });
        const r = await fetch(`${API_BASE}/totals?` + q.toString(), { method: 'GET' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        const rows = j.rows || [];

        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="muted">No results</td></tr>`;
          tfoot.style.display = 'none';
          totalCell.textContent = '0';
        } else {
          tbody.innerHTML = rows.map(x => `
            <tr class="row">
              <td>${x.program}</td>
              <td>${x.status}</td>
              <td>${x.count}</td>
            </tr>`).join('');
          const total = rows.reduce((a,b)=>a + (Number(b.count)||0), 0);
          totalCell.textContent = total;
          tfoot.style.display = '';
        }

        const totalShown = Number(totalCell.textContent || '0');
        meta.textContent = rows.length ? `${totalShown} total across ${rows.length} groups` : '';
        source.textContent = j.source === 'db-aggregated' ? 'DB aggregated' : 'Worker grouped';
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="error">Failed to load totals (${e.message})</td></tr>`;
        tfoot.style.display = 'none';
        totalCell.textContent = '0';
        meta.textContent = '';
        source.textContent = '';
      } finally {
        setLoading(false);
      }
    }

    runBtn.addEventListener('click', fetchRows);
    clearBtn.addEventListener('click', () => {
      programEl.value = 'ALL';
      recordTypeEl.value = 'ALL';
      tbody.innerHTML = `<tr><td colspan="3" class="muted">No results</td></tr>`;
      tfoot.style.display = 'none';
      totalCell.textContent = '0';
      meta.textContent = '';
      source.textContent = '';
    });

    (async function init(){
      await fetchPrograms();
      // Wait for user to click "Load Results"
    })();
  </script>
</body>
</html>
